{
  "name": "å¡è·¯é‡ŒæŸ¥è¯¢å®æ—¶",
  "nodes": [
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "text": "=You are a professional nutrition analyst. Your goal is to Analyze this food photo for each visible item and output a structured JSON with clear calorie and macro estimates.\n\nCORE FUNCTIONALITY\nâ€¢ When shown a food image, identify each item and its main components (protein, carb, fat, etc.)\nâ€¢Assume a standard reference (e.g. 26 cm dinner plate, 250 ml cup, standard fork) for scale  \n*  Note if it looks like a restaurant-prepared dishâ€”if so, assume extra cooking fat: sautÃ© or sauce fat up by ~1 Tbsp (14 g) per portion\n\n* Estimate portion sizes in grams. Use reference cues in the image (cups, standard glass size, bread size, common utensils) to scale portions.\n* Make assumptions realistic. Prefer common serving sizes.\nâ€¢ List any assumptions (shape, density, coverage %) you use to estimate size   \nâ€¢ Estimate calories & macros per item using trusted databases (USDA FoodData Central, European equivalents), adjusting for added restaurant fat\nâ€¢ Note visible cooking methods or add-ins (oil, sauce, butter)\nâ€¢ Calculate calories for each item, giving a plausible range\nâ€¢ Sum to a total calories range\n\nJSON OUTPUT SCHEMA\n\n{\n  \"overview\": \"Brief sentence about the full plate or spread\",\n  \"short_name\": \"burger with fries\",\n  \"items\": [\n    {\n      \"name\": \"Item name\",\n      \"type\": \"protein | carb | fat | beverage | etc.\",\n      \"portion_size\": \"e.g. 1 cup, 2 slices\",\n      \"cooking_method\": \"if obvious\",\n      \"macros_g\": {\n        \"protein\": 0,\n        \"carbs\": 0,\n        \"fat\": 0\n      },\n      \"calories_kcal\": {\n        \"low\": 0,\n        \"high\": 0\n      },\n      \"assumptions\": \"Any guesses you made\"\n    }\n  ],\n  \"total_calories_kcal\": {\n    \"low\": 0,\n    \"high\": 0\n  },\n  \"total_macros\": {\n      \"proteins\": {\n        \"low\": 0,\n        \"high\": 0\n      },\n      \"carbs\": {\n        \"low\": 0,\n        \"high\": 0\n      },\n      \"fat\": {\n        \"low\": 0,\n        \"high\": 0\n      },\n    },\n  \"notes\": \"Any limitations or â€œestimate may varyâ€ warnings\"\n}\n\nFOOD ANALYSIS GUIDELINES\nâ€¢ Start with â€œoverviewâ€ for the whole meal\nâ€¢ For each item, fill every field in the schema\nâ€¢ Give calories as a lowâ€“high range\nâ€¢ Explain assumptions in the â€œassumptionsâ€ field\nâ€¢ If unsure or image is unclear, add warnings in â€œnotesâ€\n* If the user is writing Additional notes regarding the food, incorporate this (This is Voluntary):\n{{ $json.filename || 'unknown.jpg' }}\n\n",
        "inputType": "base64",
        "binaryPropertyName": "data0",
        "options": {
          "maxTokens": 2000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        660,
        220
      ],
      "id": "77b5c9b6-478e-4bd9-8ec9-d485eab6d38b",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "qy20BDOTlLQJ9uMb",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  let rawJson = item.json.content;\n\n  // æ¸…ç† markdown åŒ…è£¹\n  if (rawJson.startsWith('```json')) {\n    rawJson = rawJson.replace(/^```json[\\r\\n]+/, '').replace(/```$/, '');\n  }\n\n  let parsed;\n  try {\n    parsed = JSON.parse(rawJson);\n  } catch (err) {\n    // è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¿ç•™åŸå§‹å­—ç¬¦ä¸²æ–¹ä¾¿è°ƒè¯•\n    return {\n      json: {\n        error: true,\n        message: err.message,\n        raw_snippet: rawJson.slice(0, 500) + '...'  // åªæ‰“å°å‰500ä¸ªå­—ç¬¦\n      }\n    };\n  }\n\n  return {\n    json: parsed\n  };\n});\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        240
      ],
      "id": "6edc44da-c61c-41f4-8e0f-2c04346f4449",
      "name": "è§£æç»“æ„"
    },
    {
      "parameters": {
        "public": true,
        "initialMessages": "ä½ å¥½å‘€ ğŸ‘‹\nè¯·æ‹ç…§ç»™æˆ‘ï¼Œæˆ‘ä¼šè‡ªåŠ¨è®¡ç®—ä½ æ¯é¡¿ï¼Œæ¯å¤©å’Œæ¯æœˆçš„å¡è·¯é‡Œå“¦ï½",
        "options": {
          "allowFileUploads": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -1420,
        320
      ],
      "id": "56e53be6-294a-4be5-a45d-92c125d055d7",
      "name": "When chat message received",
      "webhookId": "da0d017f-f6c8-4e4b-ad4c-2db92d19bb7f"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "ä½ æ˜¯ä¸€ä½è¥å…»å¸ˆåŠ©æ‰‹ï¼Œç”¨æˆ·çš„é—®é¢˜æ˜¯ï¼š\n{{ $json.chatInput }}\n\nä»¥ä¸‹æ˜¯ç»“æ„åŒ–çš„ç”¨æˆ·æ„å›¾ä¿¡æ¯ï¼š\næ„å›¾ï¼š{{ $json.intent }}\næ—¥æœŸï¼š{{ $json.date }}\né£Ÿç‰©ï¼š{{ $json.item }}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1060,
        1380
      ],
      "id": "4c9f9eb2-b579-43a7-956e-58c0dadf31d6",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        200,
        1620
      ],
      "id": "53aa3634-9b98-4ea5-a28a-55b9d6a55926",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "swewjuzYX9Z3PE56",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        540,
        1580
      ],
      "id": "f01dffb4-570c-48d7-8dbb-dfe0f080dbc9",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "collection": "food_analysis",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDbTool",
      "typeVersion": 1.1,
      "position": [
        1100,
        1560
      ],
      "id": "07699096-cd52-4375-a26e-e117bd2f6fb1",
      "name": "MongoDB",
      "credentials": {
        "mongoDb": {
          "id": "N6R9oqDschm5r4Cy",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "food_analysis",
        "fields": "=Date,Time,Food,Calories,Proteins,Carbs,Fat,Overview\n",
        "options": {
          "dateFields": ""
        }
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1340,
        260
      ],
      "id": "61658a0e-2558-4b31-a1db-9f8b0d62fa47",
      "name": "MongoDB1",
      "credentials": {
        "mongoDb": {
          "id": "N6R9oqDschm5r4Cy",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6c90580d-75af-4f6b-9a56-841bd56cab65",
              "name": "Date",
              "value": "={{ $now.format('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "98655c29-cc01-4140-b2c1-77656e5c3f18",
              "name": "Time",
              "value": "={{ $now.format('HH:mm:ss') }}",
              "type": "string"
            },
            {
              "id": "e9d658db-ea18-4ca8-bd6e-97331c337012",
              "name": "=Food",
              "value": "={{ $json.short_name }}",
              "type": "string"
            },
            {
              "id": "6b9696ab-a3f8-4404-9a35-3ff4b0a66171",
              "name": "Calories",
              "value": "={{ ($json.total_calories_kcal.low + $json.total_calories_kcal.high) / 2 }}",
              "type": "string"
            },
            {
              "id": "141b6660-555e-47aa-a485-a5232d2ae6c9",
              "name": "Proteins",
              "value": "={{ ($json.total_macros.proteins.low + $json.total_macros.proteins.high) / 2 }}",
              "type": "string"
            },
            {
              "id": "0a31592b-ed8d-4794-8c07-8c227c303127",
              "name": "Carbs",
              "value": "=\t{{ ($json.total_macros.carbs.low + $json.total_macros.carbs.high) / 2 }}",
              "type": "string"
            },
            {
              "id": "f3c70fb1-1abd-4970-bbdb-7db37f5c033c",
              "name": "Fat",
              "value": "=\t{{ ($json.total_macros.fat.low + $json.total_macros.fat.high) / 2 }}",
              "type": "string"
            },
            {
              "id": "9edb6d6f-5ad2-4b17-a20f-ce84aee17d77",
              "name": "Overview",
              "value": "={{ $json.overview }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1040,
        260
      ],
      "id": "ab334a02-843c-4534-9eb3-a11ea40ad4ac",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.files[0].fileExtension }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "3477ebdd-2fed-4d1a-9199-983d4a97f7fb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "20c99148-4c87-413c-a642-84af1b9eff65",
                    "leftValue": "={{ !$json.files || !$json.files[0] }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -660,
        320
      ],
      "id": "f84be2e9-d389-4652-9297-600f38a94a0f",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "aggregate",
        "collection": "food_analysis",
        "query": "=[\n  {\n    \"$match\": {\n      \"Date\": {{ $json.match.Date.$regex ? \n        `{ \"$regex\": \"${$json.match.Date.$regex}\" }` : \n        `\"${$json.match.Date}\"` }}\n    }\n  },\n  {\n    \"$group\": {\n      \"_id\": null,\n      \"totalCalories\": {\n        \"$sum\": {\n          \"$toDouble\": \"$Calories\"\n        }\n      }\n    }\n  }\n]\n"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        780,
        420
      ],
      "id": "1b2f8bfe-cb46-4946-a9df-a6033916970f",
      "name": "MongoDB2",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "N6R9oqDschm5r4Cy",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "03a6337a-534b-4a39-a9eb-4182df1f9101",
              "name": "total",
              "value": "={{ $json.totalCalories }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1460,
        500
      ],
      "id": "42915c06-4720-47e2-8297-d452d85c131e",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "let total = 0;\nlet details = [];\n\nfor (const item of items) {\n  const j = item.json;\n  \n  if (j.total !== undefined) {\n    total = j.total;\n  } else if (j.Food) {\n    details.push(\n      `- ${j.Time} åƒäº†ã€Œ${j.Food}ã€ï¼Œçƒ­é‡ ${j.Calories} åƒå¡ï¼Œè›‹ç™½è´¨ ${j.Proteins}gï¼Œç¢³æ°´ ${j.Carbs.trim()}gï¼Œè„‚è‚ª ${j.Fat.trim()}g`\n    );\n  }\n}\n\nreturn [\n  {\n    json: {\n      text: `ä½ ä»Šå¤©ä¸€å…±åƒäº† ${total} å¡è·¯é‡Œï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†è®°å½•ï¼š\\n${details.join('\\n')}\\n\\nç»§ç»­ä¿æŒå¥åº·é¥®é£Ÿå“¦ï½`\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1940,
        600
      ],
      "id": "80e7afd4-9440-4363-a1f2-a4ff64d44163",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const food = item.json.Food;\n  const calories = item.json.Calories;\n  const protein = item.json.Proteins;\n  const carbs = item.json.Carbs?.trim?.() || \"æœªçŸ¥\";\n  const fat = item.json.Fat?.trim?.() || \"æœªçŸ¥\";\n\n  return {\n    json: {\n      text: ` æ‚¨åˆšåˆšæ‘„å…¥çš„é£Ÿç‰©ä¸ºã€Œ${food}ã€ã€‚\\n çƒ­é‡çº¦ ${calories} åƒå¡ï¼Œå…¶ä¸­è›‹ç™½è´¨ ${protein}gï¼Œç¢³æ°´ ${carbs}gï¼Œè„‚è‚ª ${fat}gã€‚\\n è®°å¾—å¤šå–æ°´ï¼Œä¿æŒè¿åŠ¨å“¦ï½`\n    }\n  };\n});\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        260
      ],
      "id": "3527ef9a-955d-4f8f-a2e3-148cdb80ec0c",
      "name": "Code1"
    },
    {
      "parameters": {
        "collection": "food_analysis",
        "options": {},
        "query": "=={{ $json.query_date.length === 7\n      ? { \"Date\": { \"$regex\": \"^\" + $json.query_date } }   // æ•´æœˆï¼š^2024-06\n      : { \"Date\": $json.query_date }                       // å•æ—¥ï¼š2024-06-03\n}}\n"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        860,
        760
      ],
      "id": "5e9a6a64-c25c-4556-addc-905de4b92988",
      "name": "MongoDB3",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "N6R9oqDschm5r4Cy",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $json[\"chatInput\"];\nconst match = input.match(/(\\d{1,2})æœˆ(\\d{1,2})[å·æ—¥]?/);\n\nif (match) {\n  const year = new Date().getFullYear();  // é»˜è®¤ä¸ºä»Šå¹´\n  const month = match[1].padStart(2, '0');\n  const day = match[2].padStart(2, '0');\n  const formattedDate = `${year}-${month}-${day}`;\n  return [{ json: { query_date: formattedDate } }];\n} else {\n  return [{ json: { error: \"æ— æ³•è¯†åˆ«æ—¥æœŸï¼Œè¯·ä½¿ç”¨ 'XæœˆXå·' æ ¼å¼ã€‚\" } }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -520,
        1720
      ],
      "id": "b77f9006-ec2b-4746-8e2c-ecacbc339046",
      "name": "æå–ä¸­çš„æ—¥æœŸ"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1460,
        760
      ],
      "id": "8128925e-3b07-4484-b116-4c9aea53d2b6",
      "name": "Merge"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_today",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "010d2a01-9746-45eb-897d-1c4258802738"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "15704a3f-33f1-44dc-8b41-8bd40904b36e",
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_month",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "139f3851-c49a-4f17-ab4a-1dbec3821e0e",
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_today_item",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f08a215c-34fb-4ebb-9462-002da7249c77",
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "other ",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b4842ef1-59f5-4dfc-8653-f46d45cf1846",
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -780,
        1200
      ],
      "id": "b45298ac-b575-4486-9afd-47f28b9727fa",
      "name": "Switch1"
    },
    {
      "parameters": {
        "jsCode": "const raw = $json.message?.content;\n\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = { intent: \"other\", summary: \"è§£æå¤±è´¥\", date: null, item: null };\n}\n\nreturn [{ json: parsed }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -780,
        840
      ],
      "id": "7efc7577-792f-47ab-a612-5521ccedc8c6",
      "name": "Code2"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -380,
        1620
      ],
      "id": "b20a610d-4f53-45d3-9cad-725716849155",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n// åˆå¹¶ä¸¤ä¸ªè¾“å…¥å¯¹è±¡ï¼ˆindex 0 å’Œ 1ï¼‰\n// è·å– n8n Code èŠ‚ç‚¹é»˜è®¤è¾“å…¥ï¼šitems æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ { json: {...} }\nconst item1 = items[0].json;\nconst item2 = items[1].json;\n\n// åˆå¹¶ä¸¤ä¸ª JSON å¯¹è±¡\nconst merged = {\n  ...item1,\n  ...item2\n};\n\n// è¾“å‡ºåˆå¹¶åçš„å•ä¸ªå¯¹è±¡ï¼ˆå¿…é¡»åŒ…åœ¨æ•°ç»„é‡Œï¼‰\nreturn [{ json: merged }];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        1420
      ],
      "id": "e0f80e9d-e4fe-4089-909f-a130be0eec2a",
      "name": "Code3"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "messages": {
          "values": [
            {
              "content": "=ä½ æ˜¯ä¸€ä½æ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·ä»ç”¨æˆ·çš„è¾“å…¥ä¸­åˆ¤æ–­ä»–æƒ³æŸ¥è¯¢å“ªç±»æ•°æ®ï¼Œè¿›è¡Œæ„å›¾è¯†åˆ«ã€‚åªè¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼š\n\nåªè¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼Œä¸è¦è¾“å‡ºè§£é‡Šæ€§æ–‡å­—ï¼š\n\n{\n  \"intent\": \"query_today\" | \"query_date\" | \"query_month\" | \"query_today_item\" | \"other\",\n  \"summary\": \"ç®€è¦æè¿°ç”¨æˆ·æ„å›¾\",\n  \"date\": \"å¦‚æœç”¨æˆ·æåˆ°å…·ä½“æ—¥æœŸï¼Œè¯·è¿”å› yyyy-MM-ddï¼›å¦‚æœæ˜¯æœˆä»½ï¼ˆå¦‚â€œ6æœˆâ€ï¼‰ï¼Œè¯·è¿”å› yyyy-MMï¼›å¦åˆ™ä¸º null\",\n  \"item\": \"å¦‚æœç”¨æˆ·æåˆ°æƒ³æŸ¥è¯¢çš„å…·ä½“é£Ÿç‰©ï¼ˆå¦‚â€œç‰›è‚‰é¥­â€ï¼‰ï¼Œè¯·è¿”å›åç§°ï¼Œå¦åˆ™ä¸º null\"\n}\n\nç”¨æˆ·è¾“å…¥ï¼š{{ $json.chatInput }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1180,
        820
      ],
      "id": "fcfcb177-27e8-46f1-b764-2f59aca820ed",
      "name": "OpenAI1è¯†åˆ«æ„å›¾",
      "credentials": {
        "openAiApi": {
          "id": "swewjuzYX9Z3PE56",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const date = $json.date;\n\nlet matchCondition = {};\n\nif (date && date.length === 7) {\n  // åªæä¾›äº†æœˆä»½ï¼Œä¾‹å¦‚ \"2024-08\"\n  matchCondition = { \"Date\": { \"$regex\": \"^\" + date } };\n} else if (date && date.length === 10) {\n  // æä¾›äº†å…·ä½“æ—¥æœŸï¼Œä¾‹å¦‚ \"2024-08-01\"\n  matchCondition = { \"Date\": date };\n} else {\n  // æ²¡æœ‰æä¾›æ—¥æœŸï¼Œé»˜è®¤ä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸ\n  const now = new Date();\n  const yyyy = now.getFullYear();\n  const mm = String(now.getMonth() + 1).padStart(2, '0');\n  const dd = String(now.getDate()).padStart(2, '0');\n  const todayStr = `${yyyy}-${mm}-${dd}`;\n  matchCondition = { \"Date\": todayStr };\n}\n\nreturn [\n  {\n    json: {\n      match: matchCondition\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        980
      ],
      "id": "6e9e21c9-ca9f-460c-b8c7-92de8b94dc97",
      "name": "Code4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_today_item",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c1616360-571f-44b1-ae9f-279cf69e3a2b"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0b3ff68e-a803-4def-83f0-e4f8ae6855f0",
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "query_date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -400,
        780
      ],
      "id": "302b1452-7e0f-4c32-9353-e41e31a1bc8a",
      "name": "Switch2"
    },
    {
      "parameters": {
        "collection": "food_analysis",
        "options": {},
        "query": "={\n  \"Date\": \"{{ $now.format('yyyy-MM-dd') }}\",\n  \"Item\": \"{{ $json.item }}\"\n}\n\n"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        140,
        1340
      ],
      "id": "eb02c982-ce1c-4e87-a373-531e1e6b38e5",
      "name": "MongoDB4",
      "credentials": {
        "mongoDb": {
          "id": "piZk1QFkUWQWMup5",
          "name": "MongoDB account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n// å‡è®¾ MongoDB è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå–ç¬¬ä¸€é¡¹\nconst result = $input[0].json;\n\nif (!result || Object.keys(result).length === 0) {\n  return [\n    {\n      json: {\n        text: `æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„é£Ÿç‰©è®°å½•ï¼Œè¯·ç¡®è®¤æ‚¨ä»Šå¤©æ˜¯å¦åƒäº†è¿™ä¸ªé£Ÿç‰©ï¼Œæˆ–ç¨åå†è¯•ï½`\n      }\n    }\n  ];\n}\n\n// æå–å­—æ®µ\nconst food = result.Item || \"æœªçŸ¥é£Ÿç‰©\";\nconst calories = result.Calories || \"æœªçŸ¥\";\nconst protein = result.Protein || \"æœªçŸ¥\";\nconst carbs = result.Carbs || \"æœªçŸ¥\";\nconst fat = result.Fat || \"æœªçŸ¥\";\n\n// è¾“å‡ºæ–‡æœ¬\nconst text = ` æ‚¨åˆšåˆšæ‘„å…¥çš„é£Ÿç‰©ä¸ºã€Œ${food}ã€ã€‚\\nçƒ­é‡çº¦ ${calories} åƒå¡ï¼Œå…¶ä¸­è›‹ç™½è´¨ ${protein}gï¼Œç¢³æ°´ ${carbs}gï¼Œè„‚è‚ª ${fat}gã€‚\\nğŸ’§ è®°å¾—å¤šå–æ°´ï¼Œä¿æŒè¿åŠ¨å“¦ï½`;\n\nreturn [\n  {\n    json: { text }\n  }\n];\n;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        1180
      ],
      "id": "374376ad-6a29-41b0-8414-613d44f041a2",
      "name": "Code5"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n/**\n * è¾“å…¥ç¤ºä¾‹ï¼š\n *   { match: { Date: \"2025-06-06\" } }\n *   { match: { Date: { \"$regex\": \"^2025-06\" } } }\n */\n\nconst inObj = $json.match || {};          // å– match å¯¹è±¡\nlet queryDate = null;\n\nif (typeof inObj.Date === 'string') {\n  // å½¢å¼ï¼š \"2025-06-06\"\n  queryDate = inObj.Date;\n} else if (inObj.Date && inObj.Date.$regex) {\n  // å½¢å¼ï¼š { \"$regex\": \"^2025-06\" }\n  queryDate = inObj.Date.$regex.replace(/^(\\^)/, ''); // å»æ‰å‰å¯¼ ^\n}\n\n// å¦‚æœä¾ç„¶æ²¡æœ‰è§£æåˆ°ï¼Œå°±ç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰\nif (!queryDate) {\n  const now = new Date();\n  const yyyy = now.getFullYear();\n  const mm   = String(now.getMonth() + 1).padStart(2, '0');\n  const dd   = String(now.getDate()).padStart(2, '0');\n  queryDate  = `${yyyy}-${mm}-${dd}`; // é»˜è®¤ä»Šå¤©\n}\n\nreturn [{\n  json: { query_date: queryDate }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        1020
      ],
      "id": "2709418e-e440-4acb-8180-164a2eb11a75",
      "name": "Code6"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI": {
      "main": [
        [
          {
            "node": "è§£æç»“æ„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æç»“æ„": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "MongoDB1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OpenAI1è¯†åˆ«æ„å›¾",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB2": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB3": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "æå–ä¸­çš„æ—¥æœŸ": {
      "main": [
        []
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        []
      ]
    },
    "Code3": {
      "main": [
        []
      ]
    },
    "OpenAI1è¯†åˆ«æ„å›¾": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "MongoDB2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB4": {
      "main": [
        [
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code6": {
      "main": [
        [
          {
            "node": "MongoDB3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5e6db705-7d0c-4dbb-a94e-2714c57570f9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b3e1c66506bd07262ef78d5a57dabb2c9f245886d101c3960f62eb73e7fd816d"
  },
  "id": "3Bfj5csoeuPIlJYf",
  "tags": []
}